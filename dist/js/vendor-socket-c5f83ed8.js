import{at as t,au as i,av as s,aw as h,ax as e,ay as n,az as o}from"./vendor-aa89dd43.js";function r(t,i,s){return t.on(i,s),function(){t.off(i,s)}}const c=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class u extends i{constructor(t,i,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this.t=[],this.i=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=i,s&&s.auth&&(this.auth=s.auth),this.h=Object.assign({},s),this.io.o&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[r(t,"open",this.onopen.bind(this)),r(t,"packet",this.onpacket.bind(this)),r(t,"error",this.onerror.bind(this)),r(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io.u||this.io.open(),"open"===this.io.l&&this.onopen()),this}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...i){var h,e,n;if(c.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(i.unshift(t),this.h.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this.p(i),this;const o={type:s.EVENT,data:i,options:{}};if(o.options.compress=!1!==this.flags.compress,"function"==typeof i[i.length-1]){const t=this.ids++,s=i.pop();this.v(t,s),o.id=t}const r=null===(e=null===(h=this.io.engine)||void 0===h?void 0:h.transport)||void 0===e?void 0:e.writable,u=this.connected&&!(null===(n=this.io.engine)||void 0===n?void 0:n.m());return this.flags.volatile&&!r||(u?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}v(t,i){var s;const h=null!==(s=this.flags.timeout)&&void 0!==s?s:this.h.ackTimeout;if(void 0===h)return void(this.acks[t]=i);const e=this.io.setTimeoutFn(()=>{delete this.acks[t];for(let i=0;i<this.sendBuffer.length;i++)this.sendBuffer[i].id===t&&this.sendBuffer.splice(i,1);i.call(this,new Error("operation has timed out"))},h),n=(...t)=>{this.io.clearTimeoutFn(e),i.apply(this,t)};n.withError=!0,this.acks[t]=n}emitWithAck(t,...i){return new Promise((s,h)=>{const e=(t,i)=>t?h(t):s(i);e.withError=!0,i.push(e),this.emit(t,...i)})}p(t){let i;"function"==typeof t[t.length-1]&&(i=t.pop());const s={id:this.i++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push((t,...h)=>{if(s!==this.t[0])return;return null!==t?s.tryCount>this.h.retries&&(this.t.shift(),i&&i(t)):(this.t.shift(),i&&i(null,...h)),s.pending=!1,this.k()}),this.t.push(s),this.k()}k(t=!1){if(!this.connected||0===this.t.length)return;const i=this.t[0];i.pending&&!t||(i.pending=!0,i.tryCount++,this.flags=i.flags,this.emit.apply(this,i.args))}packet(t){t.nsp=this.nsp,this.io.O(t)}onopen(){"function"==typeof this.auth?this.auth(t=>{this._(t)}):this._(this.auth)}_(t){this.packet({type:s.CONNECT,data:this.j?Object.assign({pid:this.j,offset:this.A},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,i){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,i),this.M()}M(){Object.keys(this.acks).forEach(t=>{if(!this.sendBuffer.some(i=>String(i.id)===t)){const i=this.acks[t];delete this.acks[t],i.withError&&i.call(this,new Error("socket has been disconnected"))}})}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case s.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case s.EVENT:case s.BINARY_EVENT:this.onevent(t);break;case s.ACK:case s.BINARY_ACK:this.onack(t);break;case s.DISCONNECT:this.ondisconnect();break;case s.CONNECT_ERROR:this.destroy();const i=new Error(t.data.message);i.data=t.data.data,this.emitReserved("connect_error",i)}}onevent(t){const i=t.data||[];null!=t.id&&i.push(this.ack(t.id)),this.connected?this.emitEvent(i):this.receiveBuffer.push(Object.freeze(i))}emitEvent(t){if(this.C&&this.C.length){const i=this.C.slice();for(const s of i)s.apply(this,t)}super.emit.apply(this,t),this.j&&t.length&&"string"==typeof t[t.length-1]&&(this.A=t[t.length-1])}ack(t){const i=this;let h=!1;return function(...e){h||(h=!0,i.packet({type:s.ACK,id:t,data:e}))}}onack(t){const i=this.acks[t.id];"function"==typeof i&&(delete this.acks[t.id],i.withError&&t.data.unshift(null),i.apply(this,t.data))}onconnect(t,i){this.id=t,this.recovered=i&&this.j===i,this.j=i,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this.k(!0)}emitBuffered(){this.receiveBuffer.forEach(t=>this.emitEvent(t)),this.receiveBuffer=[],this.sendBuffer.forEach(t=>{this.notifyOutgoingListeners(t),this.packet(t)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(t=>t()),this.subs=void 0),this.io.L(this)}disconnect(){return this.connected&&this.packet({type:s.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this.C=this.C||[],this.C.push(t),this}prependAny(t){return this.C=this.C||[],this.C.unshift(t),this}offAny(t){if(!this.C)return this;if(t){const i=this.C;for(let s=0;s<i.length;s++)if(t===i[s])return i.splice(s,1),this}else this.C=[];return this}listenersAny(){return this.C||[]}onAnyOutgoing(t){return this.S=this.S||[],this.S.push(t),this}prependAnyOutgoing(t){return this.S=this.S||[],this.S.unshift(t),this}offAnyOutgoing(t){if(!this.S)return this;if(t){const i=this.S;for(let s=0;s<i.length;s++)if(t===i[s])return i.splice(s,1),this}else this.S=[];return this}listenersAnyOutgoing(){return this.S||[]}notifyOutgoingListeners(t){if(this.S&&this.S.length){const i=this.S.slice();for(const s of i)s.apply(this,t.data)}}}function a(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}a.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var i=Math.random(),s=Math.floor(i*this.jitter*t);t=1&Math.floor(10*i)?t+s:t-s}return 0|Math.min(t,this.max)},a.prototype.reset=function(){this.attempts=0},a.prototype.setMin=function(t){this.ms=t},a.prototype.setMax=function(t){this.max=t},a.prototype.setJitter=function(t){this.jitter=t};class d extends i{constructor(t,i){var s;super(),this.nsps={},this.subs=[],t&&"object"==typeof t&&(i=t,t=void 0),(i=i||{}).path=i.path||"/socket.io",this.opts=i,h(this,i),this.reconnection(!1!==i.reconnection),this.reconnectionAttempts(i.reconnectionAttempts||1/0),this.reconnectionDelay(i.reconnectionDelay||1e3),this.reconnectionDelayMax(i.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(s=i.randomizationFactor)&&void 0!==s?s:.5),this.backoff=new a({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==i.timeout?2e4:i.timeout),this.l="closed",this.uri=t;const n=i.parser||e;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this.o=!1!==i.autoConnect,this.o&&this.open()}reconnection(t){return arguments.length?(this.D=!!t,t||(this.skipReconnect=!0),this):this.D}reconnectionAttempts(t){return void 0===t?this.I:(this.I=t,this)}reconnectionDelay(t){var i;return void 0===t?this.P:(this.P=t,null===(i=this.backoff)||void 0===i||i.setMin(t),this)}randomizationFactor(t){var i;return void 0===t?this.$:(this.$=t,null===(i=this.backoff)||void 0===i||i.setJitter(t),this)}reconnectionDelayMax(t){var i;return void 0===t?this.B:(this.B=t,null===(i=this.backoff)||void 0===i||i.setMax(t),this)}timeout(t){return arguments.length?(this.F=t,this):this.F}maybeReconnectOnOpen(){!this.u&&this.D&&0===this.backoff.attempts&&this.reconnect()}open(t){if(~this.l.indexOf("open"))return this;this.engine=new n(this.uri,this.opts);const i=this.engine,s=this;this.l="opening",this.skipReconnect=!1;const h=r(i,"open",function(){s.onopen(),t&&t()}),e=i=>{this.cleanup(),this.l="closed",this.emitReserved("error",i),t?t(i):this.maybeReconnectOnOpen()},o=r(i,"error",e);if(!1!==this.F){const t=this.F,s=this.setTimeoutFn(()=>{h(),e(new Error("timeout")),i.close()},t);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}return this.subs.push(h),this.subs.push(o),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this.l="open",this.emitReserved("open");const t=this.engine;this.subs.push(r(t,"ping",this.onping.bind(this)),r(t,"data",this.ondata.bind(this)),r(t,"error",this.onerror.bind(this)),r(t,"close",this.onclose.bind(this)),r(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(i){this.onclose("parse error",i)}}ondecoded(t){o(()=>{this.emitReserved("packet",t)},this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,i){let s=this.nsps[t];return s?this.o&&!s.active&&s.connect():(s=new u(this,t,i),this.nsps[t]=s),s}L(t){const i=Object.keys(this.nsps);for(const s of i){if(this.nsps[s].active)return}this.R()}O(t){const i=this.encoder.encode(t);for(let s=0;s<i.length;s++)this.engine.write(i[s],t.options)}cleanup(){this.subs.forEach(t=>t()),this.subs.length=0,this.decoder.destroy()}R(){this.skipReconnect=!0,this.u=!1,this.onclose("forced close")}disconnect(){return this.R()}onclose(t,i){var s;this.cleanup(),null===(s=this.engine)||void 0===s||s.close(),this.backoff.reset(),this.l="closed",this.emitReserved("close",t,i),this.D&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this.u||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this.I)this.backoff.reset(),this.emitReserved("reconnect_failed"),this.u=!1;else{const i=this.backoff.duration();this.u=!0;const s=this.setTimeoutFn(()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open(i=>{i?(t.u=!1,t.reconnect(),this.emitReserved("reconnect_error",i)):t.onreconnect()}))},i);this.opts.autoUnref&&s.unref(),this.subs.push(()=>{this.clearTimeoutFn(s)})}}onreconnect(){const t=this.backoff.attempts;this.u=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const l={};function f(i,s){"object"==typeof i&&(s=i,i=void 0);const h=function(i,s="",h){let e=i;h=h||"undefined"!=typeof location&&location,null==i&&(i=h.protocol+"//"+h.host),"string"==typeof i&&("/"===i.charAt(0)&&(i="/"===i.charAt(1)?h.protocol+i:h.host+i),/^(https?|wss?):\/\//.test(i)||(i=void 0!==h?h.protocol+"//"+i:"https://"+i),e=t(i)),e.port||(/^(http|ws)$/.test(e.protocol)?e.port="80":/^(http|ws)s$/.test(e.protocol)&&(e.port="443")),e.path=e.path||"/";const n=-1!==e.host.indexOf(":")?"["+e.host+"]":e.host;return e.id=e.protocol+"://"+n+":"+e.port+s,e.href=e.protocol+"://"+n+(h&&h.port===e.port?"":":"+e.port),e}(i,(s=s||{}).path||"/socket.io"),e=h.source,n=h.id,o=h.path,r=l[n]&&o in l[n].nsps;let c;return s.forceNew||s["force new connection"]||!1===s.multiplex||r?c=new d(e,s):(l[n]||(l[n]=new d(e,s)),c=l[n]),h.query&&!s.query&&(s.query=h.queryKey),c.socket(h.path,s)}Object.assign(f,{Manager:d,Socket:u,io:f,connect:f});export{f as l};
