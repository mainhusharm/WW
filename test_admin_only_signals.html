<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin-Only Signals Test</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #1a1a1a; 
            color: white; 
        }
        .test-result { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 5px; 
        }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .info { background: #2d4a5a; }
        .warning { background: #5a4a2d; }
        .signal-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .signal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .signal-pair {
            font-size: 18px;
            font-weight: bold;
            color: #4a90e2;
        }
        .signal-direction {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .long { background: #2d5a2d; color: #90ee90; }
        .short { background: #5a2d2d; color: #ff6b6b; }
        .signal-source {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        .admin-generated { background: #2d5a2d; color: #90ee90; }
        .bot-generated { background: #5a2d2d; color: #ff6b6b; }
        .signal-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 10px 0;
        }
        .detail-item {
            text-align: center;
        }
        .detail-label {
            font-size: 12px;
            color: #888;
            margin-bottom: 5px;
        }
        .detail-value {
            font-size: 16px;
            font-weight: bold;
            color: white;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
        }
        .stat-label {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }
        button { 
            padding: 10px 20px; 
            margin: 5px; 
            background: #4a90e2; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
        }
        button:hover { background: #357abd; }
        .loading {
            text-align: center;
            padding: 20px;
            color: #888;
        }
    </style>
</head>
<body>
    <h1>üß™ Admin-Only Signals Test</h1>
    <p>This test verifies that only admin-generated signals are shown, no bot-generated or mock signals.</p>
    
    <div>
        <button onclick="loadSignals()">Load Signals</button>
        <button onclick="createTestSignal()">Create Test Signal</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="stats" class="stats" style="display: none;">
        <div class="stat-card">
            <div class="stat-number" id="totalSignals">0</div>
            <div class="stat-label">Total Signals</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="adminSignals">0</div>
            <div class="stat-label">Admin Generated</div>
        </div>
        <div class="stat-card">
            <div class="stat-number" id="botSignals">0</div>
            <div class="stat-label">Bot Generated (Ignored)</div>
        </div>
    </div>

    <div id="results"></div>
    <div id="signals-container">
        <div class="loading">Click "Load Signals" to test signal filtering...</div>
    </div>

    <script>
        let allSignals = [];
        let filteredSignals = [];
        let stats = { total: 0, admin: 0, bot: 0 };

        async function loadSignals() {
            const container = document.getElementById('signals-container');
            const resultsDiv = document.getElementById('results');
            
            container.innerHTML = '<div class="loading">üîÑ Loading signals...</div>';
            resultsDiv.innerHTML = '';
            
            try {
                // Load all signals from backend
                const response = await fetch('https://backend-gbhz.onrender.com/api/signals');
                const data = await response.json();
                
                if (data.signals && Array.isArray(data.signals)) {
                    allSignals = data.signals;
                    
                    // Filter to only show admin-generated signals
                    filteredSignals = allSignals.filter(signal => signal.source === 'admin_generated');
                    
                    updateStats();
                    renderResults();
                    renderSignals();
                    document.getElementById('stats').style.display = 'grid';
                } else {
                    container.innerHTML = '<div class="test-result error">‚ùå No signals found in response</div>';
                }
            } catch (error) {
                container.innerHTML = `<div class="test-result error">‚ùå Error loading signals: ${error.message}</div>`;
            }
        }

        function updateStats() {
            stats.total = allSignals.length;
            stats.admin = allSignals.filter(s => s.source === 'admin_generated').length;
            stats.bot = allSignals.filter(s => s.source === 'bot_generated').length;
            
            document.getElementById('totalSignals').textContent = stats.total;
            document.getElementById('adminSignals').textContent = stats.admin;
            document.getElementById('botSignals').textContent = stats.bot;
        }

        function renderResults() {
            const resultsDiv = document.getElementById('results');
            
            let html = `
                <div class="test-result info">
                    <h3>üìä Signal Analysis Results:</h3>
                    <p><strong>Total signals in backend:</strong> ${stats.total}</p>
                    <p><strong>Admin-generated signals (shown):</strong> ${stats.admin}</p>
                    <p><strong>Bot-generated signals (ignored):</strong> ${stats.bot}</p>
                </div>
            `;
            
            if (stats.bot > 0) {
                html += `
                    <div class="test-result warning">
                        <h4>‚ö†Ô∏è Bot-generated signals found and ignored:</h4>
                        ${allSignals.filter(s => s.source === 'bot_generated').map(signal => 
                            `<p>‚Ä¢ ${signal.pair} ${signal.direction} (${signal.source}) - ${signal.created_at}</p>`
                        ).join('')}
                    </div>
                `;
            }
            
            if (stats.admin > 0) {
                html += `
                    <div class="test-result success">
                        <h4>‚úÖ Admin-generated signals (will be shown):</h4>
                        ${allSignals.filter(s => s.source === 'admin_generated').map(signal => 
                            `<p>‚Ä¢ ${signal.pair} ${signal.direction} (${signal.source}) - ${signal.created_at}</p>`
                        ).join('')}
                    </div>
                `;
            }
            
            resultsDiv.innerHTML = html;
        }

        function renderSignals() {
            const container = document.getElementById('signals-container');
            
            if (filteredSignals.length === 0) {
                container.innerHTML = '<div class="test-result info">‚ÑπÔ∏è No admin-generated signals available</div>';
                return;
            }

            let html = '<h3>üìã Admin-Generated Signals (Shown in User Dashboard):</h3>';
            filteredSignals.forEach(signal => {
                const directionClass = signal.direction === 'LONG' ? 'long' : 'short';
                const directionText = signal.direction === 'LONG' ? 'BUY' : 'SELL';
                
                html += `
                    <div class="signal-card">
                        <div class="signal-header">
                            <div class="signal-pair">${signal.pair}</div>
                            <div style="display: flex; gap: 10px; align-items: center;">
                                <div class="signal-direction ${directionClass}">${directionText}</div>
                                <div class="signal-source admin-generated">ADMIN</div>
                            </div>
                        </div>
                        
                        <div class="signal-details">
                            <div class="detail-item">
                                <div class="detail-label">Entry Price</div>
                                <div class="detail-value">${signal.entry_price}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Stop Loss</div>
                                <div class="detail-value">${signal.stop_loss}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Take Profit</div>
                                <div class="detail-value">${signal.take_profit}</div>
                            </div>
                        </div>
                        
                        <div style="margin: 10px 0; padding: 10px; background: #333; border-radius: 4px;">
                            <strong>Analysis:</strong> ${signal.analysis}
                        </div>
                        
                        <div style="margin-top: 10px; font-size: 12px; color: #888;">
                            <strong>Confidence:</strong> ${signal.confidence}% | 
                            <strong>Created:</strong> ${new Date(signal.created_at).toLocaleString()}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function createTestSignal() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">üîÑ Creating test signal...</div>';
            
            try {
                const testSignal = {
                    pair: "USDJPY",
                    direction: "LONG",
                    entry: "149.50",
                    stopLoss: "149.00",
                    takeProfit: "150.50",
                    confidence: 88,
                    analysis: "Test signal created from user dashboard - Bullish momentum with order block confirmation and fair value gap continuation",
                    ictConcepts: ["Order Block", "Fair Value Gap", "Market Structure"],
                    market: "forex",
                    timeframe: "1h"
                };
                
                const response = await fetch('https://backend-gbhz.onrender.com/api/admin/create-signal', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testSignal)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    resultsDiv.innerHTML = `
                        <div class="test-result success">
                            ‚úÖ Test signal created successfully!<br>
                            Signal ID: ${result.signal_id}<br>
                            Created: ${result.created_at}
                        </div>
                    `;
                    
                    // Reload signals to show the new one
                    setTimeout(() => {
                        loadSignals();
                    }, 1000);
                } else {
                    resultsDiv.innerHTML = `<div class="test-result error">‚ùå Failed to create test signal: ${response.status}</div>`;
                }
            } catch (error) {
                resultsDiv.innerHTML = `<div class="test-result error">‚ùå Error creating test signal: ${error.message}</div>`;
            }
        }

        function clearResults() {
            allSignals = [];
            filteredSignals = [];
            stats = { total: 0, admin: 0, bot: 0 };
            document.getElementById('signals-container').innerHTML = '<div class="loading">Results cleared. Click "Load Signals" to reload.</div>';
            document.getElementById('results').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
        }

        // Auto-load signals on page load
        window.addEventListener('load', () => {
            loadSignals();
        });
    </script>
</body>
</html>
